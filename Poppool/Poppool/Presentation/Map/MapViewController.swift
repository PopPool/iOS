import UIKit
import FloatingPanel
import SnapKit
import RxSwift
import RxCocoa
import ReactorKit
import GoogleMaps
import CoreLocation
import RxGesture


final class MapViewController: BaseViewController, View {
    typealias Reactor = MapReactor

    // MARK: - Properties
    var disposeBag = DisposeBag()
    let mainView = MapView()
    let carouselView = MapPopupCarouselView()
    private let locationManager = CLLocationManager()
    private var currentMarker: GMSMarker?
    private let storeListViewController = StoreListViewController(reactor: StoreListReactor())
    private var listViewTopConstraint: Constraint?
    private var currentFilterBottomSheet: FilterBottomSheetViewController?
    private var filterChipsTopY: CGFloat = 0
    private var filterContainerBottomY: CGFloat {
        let frameInView = mainView.filterChips.convert(mainView.filterChips.bounds, to: view)
        return frameInView.maxY // ÌïÑÌÑ∞ Ïª®ÌÖåÏù¥ÎÑàÏùò Î∞îÎã• ÎÜíÏù¥
    }

    enum ModalState {
        case top
        case middle
        case bottom
    }

    private var modalState: ModalState = .bottom

    // MARK: - Lifecycle
    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        DispatchQueue.main.async {
            self.view.layoutIfNeeded()
            let frameInView = self.mainView.filterChips.convert(self.mainView.filterChips.bounds, to: self.view)
            self.filterChipsTopY = frameInView.minY
        }
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        setUp()
        checkLocationAuthorization()
        locationManager.delegate = self
        locationManager.requestWhenInUseAuthorization()
        locationManager.desiredAccuracy = kCLLocationAccuracyBest
    }


    // MARK: - Setup
    private func setUp() {
        view.addSubview(mainView)
        mainView.snp.makeConstraints { make in
            make.edges.equalToSuperview()
        }

        view.addSubview(carouselView)
        carouselView.snp.makeConstraints { make in
            make.leading.trailing.equalToSuperview()
            make.height.equalTo(140)
            make.bottom.equalTo(view.safeAreaLayoutGuide).offset(-16)
        }
        carouselView.isHidden = true
        mainView.mapView.delegate = self

        // Î¶¨Ïä§Ìä∏Î∑∞ ÏÑ§Ï†ï
        addChild(storeListViewController)
        view.addSubview(storeListViewController.view)
        storeListViewController.didMove(toParent: self)

        storeListViewController.view.snp.makeConstraints { make in
            make.leading.trailing.equalToSuperview()
            make.bottom.equalToSuperview()
            listViewTopConstraint = make.top.equalToSuperview().offset(view.frame.height).constraint // Ï¥àÍ∏∞ Ïà®ÍπÄ ÏÉÅÌÉú
        }

        // Ï†úÏä§Ï≤ò ÏÑ§Ï†ï
        let panGesture = UIPanGestureRecognizer(target: self, action: #selector(handlePanGesture(_:)))
        storeListViewController.mainView.grabberHandle.addGestureRecognizer(panGesture)
        storeListViewController.mainView.addGestureRecognizer(panGesture)
        setupPanAndSwipeGestures()


        setupMarker()
    }

    private func setupMarker() {
        let marker = GMSMarker()
        marker.position = CLLocationCoordinate2D(latitude: 37.5666, longitude: 126.9784)
        let markerView = MapMarker()
        markerView.injection(with: .init(title: "ÏÑúÏö∏", count: 3))
        marker.iconView = markerView
        marker.map = mainView.mapView
        markerView.frame = CGRect(x: 0, y: 0, width: 80, height: 28)
    }

    private func setupPanAndSwipeGestures() {
        // grabberHandleÏóê Ïä§ÏôÄÏù¥ÌîÑ Ï†úÏä§Ï≤ò Ï∂îÍ∞Ä
        storeListViewController.mainView.grabberHandle.rx.swipeGesture(.up)
            .skip(1)
            .withUnretained(self)
            .subscribe { owner, _ in
                print("[DEBUG] ‚¨ÜÔ∏è Swipe Up Detected")
                switch owner.modalState {
                case .bottom:
                    owner.animateToState(.middle)
                case .middle:
                    owner.animateToState(.top)
                case .top:
                    break
                }
            }
            .disposed(by: disposeBag)

        storeListViewController.mainView.grabberHandle.rx.swipeGesture(.down)
            .skip(1)
            .withUnretained(self)
            .subscribe { owner, _ in
                print("[DEBUG] ‚¨áÔ∏è Swipe Down Detected")
                switch owner.modalState {
                case .top:
                    owner.animateToState(.middle)
                case .middle:
                    owner.animateToState(.bottom)
                case .bottom:
                    break
                }
            }
            .disposed(by: disposeBag)
    }

    // MARK: - Bind
    func bind(reactor: Reactor) {
        // ÌïÑÌÑ∞ Í¥ÄÎ†® Î∞îÏù∏Îî©
        mainView.filterChips.locationChip.rx.tap
            .map { Reactor.Action.filterTapped(.location) }
            .bind(to: reactor.action)
            .disposed(by: disposeBag)

        mainView.filterChips.categoryChip.rx.tap
            .map { Reactor.Action.filterTapped(.category) }
            .bind(to: reactor.action)
            .disposed(by: disposeBag)

        // Î¶¨Ïä§Ìä∏ Î≤ÑÌäº ÌÉ≠
        mainView.listButton.rx.tap
            .withUnretained(self)
            .subscribe { owner, _ in
                print("[DEBUG] List Button Tapped")
                owner.animateToState(.middle) // Î≤ÑÌäº ÎàåÎ†ÄÏùÑ Îïå ÏÉÅÌÉúÎ•º middleÎ°ú Î≥ÄÍ≤Ω
            }
            .disposed(by: disposeBag)

        // ÏúÑÏπò Î≤ÑÌäº
        mainView.locationButton.rx.tap
            .bind { [weak self] _ in
                guard let self = self else { return }
                self.locationManager.startUpdatingLocation()
            }
            .disposed(by: disposeBag)



        mainView.filterChips.onRemoveLocation = {
            reactor.action.onNext(.clearFilters(.location))
        }
        mainView.filterChips.onRemoveCategory = {
            reactor.action.onNext(.clearFilters(.category))
        }

        Observable.combineLatest(
            reactor.state.map { $0.selectedLocationFilters }.distinctUntilChanged(),
            reactor.state.map { $0.selectedCategoryFilters }.distinctUntilChanged()
        ) { locationFilters, categoryFilters -> (String, String) in
            // ÏßÄÏó≠ ÌïÑÌÑ∞ ÌÖçÏä§Ìä∏ Ìè¨Îß∑ÌåÖ
            let locationText: String
            if locationFilters.isEmpty {
                locationText = "ÏßÄÏó≠ÏÑ†ÌÉù"
            } else if locationFilters.count > 1 {
                locationText = "\(locationFilters[0]) Ïô∏ \(locationFilters.count - 1)Í∞ú"
            } else {
                locationText = locationFilters[0]
            }

            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ ÌÖçÏä§Ìä∏ Ìè¨Îß∑ÌåÖ
            let categoryText: String
            if categoryFilters.isEmpty {
                categoryText = "Ïπ¥ÌÖåÍ≥†Î¶¨"
            } else if categoryFilters.count > 1 {
                categoryText = "\(categoryFilters[0]) Ïô∏ \(categoryFilters.count - 1)Í∞ú"
            } else {
                categoryText = categoryFilters[0]
            }
            return (locationText, categoryText)
        }
        .observe(on: MainScheduler.instance)
        .bind { [weak self] locationText, categoryText in
            print("[DEBUG] üìç Updating filters - Location: \(locationText)")
            print("[DEBUG] üè∑Ô∏è Updating filters - Category: \(categoryText)")

            self?.mainView.filterChips.update(
                locationText: locationText,
                categoryText: categoryText
            )
        }
        .disposed(by: disposeBag)

        reactor.state.map { $0.activeFilterType }
            .distinctUntilChanged()
            .observe(on: MainScheduler.instance)
            .subscribe(onNext: { [weak self] filterType in
                guard let self = self else { return }
                if let filterType = filterType {
                    self.presentFilterBottomSheet(for: filterType)
                } else {
                    self.dismissFilterBottomSheet()
                }
            })
            .disposed(by: disposeBag)
        reactor.state.map { $0.searchResult }
            .distinctUntilChanged()
            .compactMap { $0 }
            .observe(on: MainScheduler.instance)
            .bind { [weak self] store in
                guard let self = self else { return }
                let camera = GMSCameraPosition.camera(
                    withLatitude: store.latitude,
                    longitude: store.longitude,
                    zoom: 15
                )
                self.mainView.mapView.animate(to: camera)
                self.addMarker(for: store)
            }
            .disposed(by: disposeBag)

//        reactor.state.map { $0.toastMessage }
//            .compactMap { $0 }
//            .observe(on: MainScheduler.instance)
//            .bind { message in
////                let toast = Toast(message: message)
//                toast.show()
//            }
//            .disposed(by: disposeBag)

    }
    

    // MARK: - List View Control
    private func toggleListView() {
        print("[DEBUG] Current Modal State: \(modalState)")
        print("[DEBUG] Current listViewTopConstraint offset: \(listViewTopConstraint?.layoutConstraints.first?.constant ?? 0)")

        UIView.animate(withDuration: 0.3) {
            let middleOffset = -self.view.frame.height * 0.7 
            self.listViewTopConstraint?.update(offset: middleOffset)
            self.modalState = .middle
            self.mainView.searchFilterContainer.backgroundColor = .clear
            print("[DEBUG] Changing state to Middle")
            print("[DEBUG] Updated offset: \(middleOffset)")
            self.view.layoutIfNeeded()
        }

        // ÏÉÅÌÉú Î≥ÄÍ≤Ω ÌõÑ Î°úÍ∑∏
        print("[DEBUG] New Modal State: \(modalState)")
        print("[DEBUG] New listViewTopConstraint offset: \(listViewTopConstraint?.layoutConstraints.first?.constant ?? 0)")
    }

    func addMarker(for store: MapPopUpStore) {
          let marker = GMSMarker()
          marker.position = store.coordinate
          marker.userData = store

          let markerView = MapMarker()
          markerView.injection(with: store.toMarkerInput())
          marker.iconView = markerView
          marker.map = mainView.mapView
      }

    @objc private func handlePanGesture(_ gesture: UIPanGestureRecognizer) {
        let translation = gesture.translation(in: view)
        let velocity = gesture.velocity(in: view)

        switch gesture.state {
        case .changed:
            if let constraint = listViewTopConstraint {
                let currentOffset = constraint.layoutConstraints.first?.constant ?? 0
                let newOffset = currentOffset + translation.y

                // Ïò§ÌîÑÏÖã Ï†úÌïú Î≤îÏúÑ ÏÑ§Ï†ï
                let minOffset: CGFloat = filterContainerBottomY // ÌïÑÌÑ∞ Ïª®ÌÖåÏù¥ÎÑà Î∞îÎã• Ï†úÌïú
                let maxOffset: CGFloat = view.frame.height // ÏµúÌïòÎã® Ï†úÌïú
                let clampedOffset = min(max(newOffset, minOffset), maxOffset)

                constraint.update(offset: clampedOffset)
                gesture.setTranslation(.zero, in: view)

                // ÏïåÌååÍ∞í Ï°∞Ï†à: ÌÉë ÏÉÅÌÉúÏóêÏÑúÎßå Ï†ÅÏö©
                if modalState == .top {
                    adjustMapViewAlpha(for: clampedOffset, minOffset: minOffset, maxOffset: maxOffset)
                }
            }

        case .ended:
            if let constraint = listViewTopConstraint {
                let currentOffset = constraint.layoutConstraints.first?.constant ?? 0
                let middleY = view.frame.height * 0.3 // Ï§ëÍ∞Ñ ÏßÄÏ†ê Í∏∞Ï§Ä ÎÜíÏù¥
                let targetState: ModalState

                // ÏÜçÎèÑÏôÄ ÏúÑÏπòÎ•º Í∏∞Î∞òÏúºÎ°ú ÏÉÅÌÉú Í≤∞Ï†ï
                if velocity.y > 500 { // ÏïÑÎûòÎ°ú Îπ†Î•¥Í≤å ÎìúÎûòÍ∑∏
                    targetState = .bottom
                } else if velocity.y < -500 { // ÏúÑÎ°ú Îπ†Î•¥Í≤å ÎìúÎûòÍ∑∏
                    targetState = .top
                } else if currentOffset < middleY * 0.7 {
                    targetState = .top
                } else if currentOffset < view.frame.height * 0.7 {
                    targetState = .middle
                } else {
                    targetState = .bottom
                }

                // ÏµúÏ¢Ö ÏÉÅÌÉúÏóê Îî∞Îùº Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ÅÏö©
                animateToState(targetState)
            }

        default:
            break
        }
    }

    private func adjustMapViewAlpha(for offset: CGFloat, minOffset: CGFloat, maxOffset: CGFloat) {
        let middleOffset = view.frame.height * 0.3 // ÎØ∏Îì§ ÏÉÅÌÉú Í∏∞Ï§Ä ÎÜíÏù¥

        if offset <= minOffset {
            mainView.mapView.alpha = 0 // ÌÉëÏóêÏÑúÎäî ÏôÑÏ†ÑÌûà Ïà®ÍπÄ
        } else if offset >= maxOffset {
            mainView.mapView.alpha = 1 // Î∞îÌÖÄÏóêÏÑúÎäî ÏôÑÏ†ÑÌûà Î≥¥ÏûÑ
        } else if offset <= middleOffset {
            // ÌÉë ~ ÎØ∏Îì§ ÏÇ¨Ïù¥ÏóêÏÑúÎäî ÏïåÌååÍ∞í Ï†êÏßÑÏ†Å Ï¶ùÍ∞Ä
            let progress = (offset - minOffset) / (middleOffset - minOffset)
            mainView.mapView.alpha = progress
        } else {
            // ÎØ∏Îì§ ~ Î∞îÌÖÄ ÏÇ¨Ïù¥ÏóêÏÑúÎäî Ìï≠ÏÉÅ Î≥¥ÏûÑ
            mainView.mapView.alpha = 1
        }
    }

    private func updateMapViewAlpha(for offset: CGFloat, minOffset: CGFloat, maxOffset: CGFloat) {
        let progress = (maxOffset - offset) / (maxOffset - minOffset) // 0(ÌÉë) ~ 1(Î∞îÌÖÄ)
        mainView.mapView.alpha = max(0, min(progress, 1)) // 0(ÏôÑÏ†ÑÌûà Í∞ÄÎ¶º) ~ 1(ÏôÑÏ†ÑÌûà Î≥¥ÏûÑ)
    }
    private func animateToState(_ state: ModalState) {
        guard modalState != state else { return }
        self.view.layoutIfNeeded()

        UIView.animate(withDuration: 0.3, animations: {
            switch state {
            case .top:
                let filterChipsFrame = self.mainView.filterChips.convert(
                    self.mainView.filterChips.bounds,
                    to: self.view
                )
                self.mainView.mapView.alpha = 0 // ÌÉë ÏÉÅÌÉúÏóêÏÑúÎäî Ïà®ÍπÄ
                self.storeListViewController.setGrabberHandleVisible(false)
                self.listViewTopConstraint?.update(offset: filterChipsFrame.maxY)
                self.mainView.searchInput.backgroundColor = .g50


            case .middle:
                self.storeListViewController.setGrabberHandleVisible(true)
                // ÌïÑÌÑ∞ Ïª®ÌÖåÏù¥ÎÑà Î∞îÎã• ÎÜíÏù¥Î•º ÏµúÏÜåÍ∞íÏúºÎ°ú ÏÇ¨Ïö©
                let offset = max(self.view.frame.height * 0.3, self.filterContainerBottomY)
                self.listViewTopConstraint?.update(offset: offset)
                self.storeListViewController.mainView.layer.cornerRadius = 20
                self.storeListViewController.mainView.layer.maskedCorners = [.layerMinXMinYCorner, .layerMaxXMinYCorner]
                self.mainView.mapView.alpha = 1 // ÎØ∏Îì§ ÏÉÅÌÉúÏóêÏÑúÎäî Ìï≠ÏÉÅ Î≥¥ÏûÑ
                self.mainView.mapView.isHidden = false
                self.mainView.searchInput.backgroundColor = .white


            case .bottom:
                self.storeListViewController.setGrabberHandleVisible(true)
                self.listViewTopConstraint?.update(offset: self.view.frame.height) // ÌôîÎ©¥ ÏïÑÎûòÎ°ú Ïà®ÍπÄ
                self.mainView.mapView.alpha = 1 // Î∞îÌÖÄ ÏÉÅÌÉúÏóêÏÑúÎäî Ìï≠ÏÉÅ Î≥¥ÏûÑ
                self.mainView.mapView.isHidden = false
                self.mainView.searchInput.backgroundColor = .white

            }

            self.view.layoutIfNeeded()
        }) { _ in
            self.modalState = state
            print("Completed animation to state: \(state)")
        }
    }


    func presentFilterBottomSheet(for filterType: FilterType) {
        let sheetReactor = FilterBottomSheetReactor()
        let viewController = FilterBottomSheetViewController(reactor: sheetReactor)

        let initialIndex = (filterType == .location) ? 0 : 1
        viewController.containerView.segmentedControl.selectedSegmentIndex = initialIndex
        sheetReactor.action.onNext(.segmentChanged(initialIndex))

        viewController.onSave = { [weak self] filterData in
              guard let self = self else { return }

              print("[DEBUG] üíæ Save triggered with:")
              print("[DEBUG] üìç Locations: \(filterData.locations)")
              print("[DEBUG] üè∑Ô∏è Categories: \(filterData.categories)")

              self.reactor?.action.onNext(.updateBothFilters(
                  locations: filterData.locations,
                  categories: filterData.categories
              ))
              self.reactor?.action.onNext(.filterTapped(nil))
          }

        viewController.onSave = { [weak self] filterData in
            guard let self = self else { return }
            self.reactor?.action.onNext(.updateBothFilters(
                locations: filterData.locations,
                categories: filterData.categories
            ))
            self.reactor?.action.onNext(.filterTapped(nil))
        }

        viewController.onDismiss = { [weak self] in
            self?.reactor?.action.onNext(.filterTapped(nil))
        }

        viewController.modalPresentationStyle = .overFullScreen
        present(viewController, animated: false) {
            viewController.showBottomSheet()
        }

        currentFilterBottomSheet = viewController
    }
    private func dismissFilterBottomSheet() {
        if let bottomSheet = currentFilterBottomSheet {
            bottomSheet.hideBottomSheet()
        }
        currentFilterBottomSheet = nil
    }

    // MARK: - Location
    private func checkLocationAuthorization() {
        let status = CLLocationManager.authorizationStatus()
        switch status {
        case .notDetermined:
            locationManager.requestWhenInUseAuthorization()
        case .authorizedWhenInUse, .authorizedAlways:
            locationManager.startUpdatingLocation()
        case .denied, .restricted:
            print("ÏúÑÏπò ÏÑúÎπÑÏä§Í∞Ä ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. ÏÑ§Ï†ïÏóêÏÑú Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.")
        @unknown default:
            break
        }
    }
}

// MARK: - CLLocationManagerDelegate
extension MapViewController: CLLocationManagerDelegate {
    func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {
        guard let location = locations.last else { return }

        let camera = GMSCameraPosition.camera(withLatitude: location.coordinate.latitude,
                                            longitude: location.coordinate.longitude,
                                            zoom: 15)
        mainView.mapView.animate(to: camera)

        let currentLocationStore = MapPopUpStore(
            id: 0,
            category: "ÌòÑÏû¨ ÏúÑÏπò",
            name: "ÌòÑÏúÑÏπò ÌåùÏóÖ",
            address: "ÌòÑÏû¨ ÏúÑÏπò Í∏∞Î∞ò Ï£ºÏÜå",
            startDate: "2024.01.01",
            endDate: "2024.12.31",
            latitude: location.coordinate.latitude,
            longitude: location.coordinate.longitude,
            markerId: 0,
            markerTitle: "ÌòÑÏû¨ ÏúÑÏπò",
            markerSnippet: "ÌòÑÏû¨ ÏúÑÏπòÏùò ÌåùÏóÖÏä§ÌÜ†Ïñ¥"
        )

        addMarker(for: currentLocationStore)
        locationManager.stopUpdatingLocation()
    }
}

// MARK: - GMSMapViewDelegate
extension MapViewController: GMSMapViewDelegate {
    func mapView(_ mapView: GMSMapView, didTap marker: GMSMarker) -> Bool {
        let dummyStore1 = MapPopUpStore(
            id: 1,
            category: "Ïπ¥Ìéò",
            name: "ÌåùÏóÖÏä§ÌÜ†Ïñ¥Î™Ö ÌåùÏóÖÏä§ÌÜ†Ïñ¥Î™Ö ÏµúÎåÄ 2Ï§Ñ ÎßêÏ§ÑÏûÑ...",
            address: "ÏÑúÏö∏ÌäπÎ≥ÑÏãú Ï§ëÍµ¨",
            startDate: "2024.01.01",
            endDate: "2024.12.31",
            latitude: 37.5665,
            longitude: 126.9780,
            markerId: 1,
            markerTitle: "ÏÑúÏö∏",
            markerSnippet: "ÌåùÏóÖÏä§ÌÜ†Ïñ¥"
        )
        let dummyStore2 = MapPopUpStore(
            id: 2,
            category: "Ï†ÑÏãú/ÏòàÏà†",
            name: "Ï†ÑÏãú ÌåùÏóÖÏä§ÌÜ†Ïñ¥ ÌåùÏóÖÏä§ÌÜ†Ïñ¥Î™Ö ÏµúÎåÄ 2Ï§Ñ ÎßêÏ§ÑÏûÑ...",
            address: "ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í∞ïÎÇ®Íµ¨",
            startDate: "2024.06.01",
            endDate: "2024.12.31",
            latitude: 37.4980,
            longitude: 127.0276,
            markerId: 2,
            markerTitle: "Í∞ïÎÇ®",
            markerSnippet: "Ï†ÑÏãú ÌåùÏóÖÏä§ÌÜ†Ïñ¥"
        )

        carouselView.updateCards([dummyStore1, dummyStore2])
        carouselView.isHidden = false

        return true
    }
}
