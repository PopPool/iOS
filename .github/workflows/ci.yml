name: CI

on:
  pull_request:
    branches: [dev]
  push:
    branches: [dev]

jobs:
  autocorrect:
    name: ğŸ¤– Autocorrect Workflow
    runs-on: macos-15  # ìµœì‹  macOS 15 í™˜ê²½ì—ì„œ ì‹¤í–‰
    if: github.actor != 'github-actions[bot]'  # Actions ë´‡ ì»¤ë°‹ì€ ë¬´ì‹œ

    steps:
      - name: Checkout Repository  # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Set up Xcode  # Xcode 16.2 ì„ íƒ
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: â¬‡ï¸ Install SwiftLint  # SwiftLint ì„¤ì¹˜
        run: brew install swiftlint

      - name: ğŸ¨ Run SwiftLint Autocorrect  # SwiftLint ìë™ ìˆ˜ì • ì‹¤í–‰
        run: swiftlint --fix

      - name: ğŸš€ Commit and Push Changes  # ë³€ê²½ ì‚¬í•­ ìë™ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout "${GITHUB_HEAD_REF}"

          BRANCH_NAME="${GITHUB_HEAD_REF}"
          if [[ "$BRANCH_NAME" =~ ([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
          else
            ISSUE_NUMBER=""
          fi

          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "style/#${ISSUE_NUMBER}: Apply SwiftLint autocorrect"
            git push
          else
            echo "No changes to commit"
          fi

  build:
    name: ğŸ—ï¸ Build Workflow
    runs-on: macos-15  # ìµœì‹  macOS 15 í™˜ê²½ì—ì„œ ì‹¤í–‰
    if: github.actor != 'github-actions[bot]'  # Actions ë´‡ ì»¤ë°‹ì€ ë¬´ì‹œ

    steps:
      - name: Checkout Repository  # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Generate xcconfig
        run: |
          cat <<EOF > Poppool/Poppool/Resource/Debug.xcconfig
          KAKAO_AUTH_APP_KEY=${{ secrets.KAKAO_AUTH_APP_KEY }}
          NAVER_MAP_CLIENT_ID=${{ secrets.NAVER_MAP_CLIENT_ID }}
          POPPOOL_BASE_URL=${{ secrets.POPPOOL_BASE_URL }}
          POPPOOL_S3_BASE_URL=${{ secrets.POPPOOL_S3_BASE_URL }}
          POPPOOL_API_KEY=${{ secrets.POPPOOL_API_KEY }}
          EOF

      - name: ğŸ› ï¸ Select Xcode 16.2  # Xcode 16.2 ë²„ì „ ì‚¬ìš© ì„¤ì •
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: â¬‡ï¸ Install SwiftLint  # SwiftLint ì„¤ì¹˜
        run: brew install swiftlint
        
      - name: ğŸ¨ Run SwiftLint  # SwiftLint ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ì‹¤í–‰
        run: swiftlint

      - name: ğŸ” Detect Default Scheme  # ê¸°ë³¸ scheme ìë™ ê²€ì§€
        id: detect_scheme
        run: |
          SCHEME=$(xcodebuild -list -json | jq -r '.project.schemes[0]')
          echo "Detected scheme: $SCHEME"
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: ğŸ” Detect Latest iPhone Simulator  # ìµœì‹  ì‚¬ìš© ê°€ëŠ¥í•œ iPhone ì‹œë®¬ë ˆì´í„° ê²€ì§€
        id: detect_latest_simulator
        run: |
          DEVICE=$(xcrun simctl list devices available | grep -Eo 'iPhone .* \([0-9A-F\-]+\)' | head -n 1)
          UDID=$(echo "$DEVICE" | grep -Eo '[0-9A-F\-]{36}')
          NAME=$(echo "$DEVICE" | cut -d '(' -f1 | xargs)
          echo "Detected simulator: $NAME ($UDID)"
          echo "sim_name=$NAME" >> "$GITHUB_OUTPUT"
          echo "sim_udid=$UDID" >> "$GITHUB_OUTPUT"

      - name: ğŸ—ï¸ Build the project  # ìë™ ê²€ì§€ëœ Schemeê³¼ Simulatorë¡œ ë¹Œë“œ ìˆ˜í–‰
        run: |
          WORKSPACE=$(find . -name "*.xcworkspace" | head -n 1)
          xcodebuild -scheme "${{ steps.detect_scheme.outputs.scheme }}" \
            -workspace "$WORKSPACE" \
            -destination "platform=iOS Simulator,id=${{ steps.detect_latest_simulator.outputs.sim_udid }}" \
            clean build | xcpretty
